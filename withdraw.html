<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ | DZ-TRAFFIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <nav class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-50">
        <a href="dashboard.html" class="text-blue-600 font-bold flex items-center gap-2">
            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù‡Ø§Ù…
        </a>
        <div class="bg-green-100 text-green-800 px-4 py-1 rounded-full font-bold">
            Ø±ØµÙŠØ¯Ùƒ: <span id="currentPoints">0</span> ğŸª™
        </div>
    </nav>

    <div class="max-w-md mx-auto p-6 mt-8">
        <div class="text-center mb-10">
            <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg">
                <i class="fas fa-wallet"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-800">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ ÙÙ„ÙŠÙƒØ³ÙŠ</h2>
            <p class="text-gray-500 text-sm">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„ÙŠØµÙ„Ùƒ Ø§Ù„Ø±ØµÙŠØ¯</p>
        </div>

        <div class="space-y-4">
            <div onclick="selectAmount(100, 1000)" class="offer-card group bg-white p-5 rounded-2xl border-2 border-transparent hover:border-blue-500 shadow-sm cursor-pointer transition-all">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="block text-xl font-bold text-gray-800">100 Ø¯Ø¬</span>
                        <span class="text-xs text-gray-400">ÙÙ„ÙŠÙƒØ³ÙŠ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¨ÙƒØ§Øª)</span>
                    </div>
                    <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        1000 Ù†Ù‚Ø·Ø©
                    </div>
                </div>
            </div>

            <div onclick="selectAmount(200, 2000)" class="offer-card group bg-white p-5 rounded-2xl border-2 border-transparent hover:border-blue-500 shadow-sm cursor-pointer transition-all">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="block text-xl font-bold text-gray-800">200 Ø¯Ø¬</span>
                        <span class="text-xs text-gray-400">ÙÙ„ÙŠÙƒØ³ÙŠ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¨ÙƒØ§Øª)</span>
                    </div>
                    <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        2000 Ù†Ù‚Ø·Ø©
                    </div>
                </div>
            </div>
        </div>

        <form id="withdrawForm" class="mt-10 space-y-4 hidden animate-in slide-in-from-bottom-4 duration-500">
            <input type="hidden" id="selectedDA">
            <input type="hidden" id="selectedPoints">
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                <p class="text-blue-800 text-sm font-bold text-center">
                    Ø³ÙŠØªÙ… Ø³Ø­Ø¨ <span id="viewPoints">0</span> Ù†Ù‚Ø·Ø© Ù…Ù‚Ø§Ø¨Ù„ <span id="viewDA">0</span> Ø¯Ø¬
                </p>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                <input type="tel" id="phoneNumber" placeholder="06XXXXXXXX / 07XXXXXXXX" 
                       class="w-full p-4 border-2 rounded-xl focus:border-blue-500 outline-none transition" required>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-blue-700 transition transform active:scale-95">
                ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ğŸš€
            </button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = "https://nbioqaxgjzpyrbcwdkds.supabase.co"; 
        const SUPABASE_KEY = "Ø¶Ø¹Ù‡_Ù‡Ù†Ø§_Ù…Ù†_Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª_API_Keys"; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadProfile() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }
            
            const { data: profile } = await supabaseClient.from('profiles').select('points').eq('id', user.id).single();
            document.getElementById('currentPoints').innerText = profile?.points?.toLocaleString() || 0;
        }

        function selectAmount(da, pts) {
            document.querySelectorAll('.offer-card').forEach(c => c.classList.remove('border-blue-500', 'bg-blue-50'));
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            
            document.getElementById('selectedDA').value = da;
            document.getElementById('selectedPoints').value = pts;
            document.getElementById('viewDA').innerText = da;
            document.getElementById('viewPoints').innerText = pts;
            document.getElementById('withdrawForm').classList.remove('hidden');
        }

        document.getElementById('withdrawForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

            const { data: { user } } = await supabaseClient.auth.getUser();
            const da = parseInt(document.getElementById('selectedDA').value);
            const pts = parseInt(document.getElementById('selectedPoints').value);
            const phone = document.getElementById('phoneNumber').value;

            // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§ÙÙŠ
            const { data: profile } = await supabaseClient.from('profiles').select('points').eq('id', user.id).single();
            
            if (profile.points < pts) {
                alert("Ø±ØµÙŠØ¯ Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!");
                btn.disabled = false;
                btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ğŸš€";
                return;
            }

            // 2. Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡Ø§ ÙÙŠ SQL)
            const { error: rpcError } = await supabaseClient.rpc('increment_points', { 
                user_id: user.id, 
                amount: -pts 
            });

            if (!rpcError) {
                // 3. ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                await supabaseClient.from('withdrawals').insert([
                    { user_id: user.id, phone_number: phone, amount_da: da, points_cost: pts }
                ]);
                
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø´Ø­Ù† Ø±ØµÙŠØ¯Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.");
                window.location.href = "dashboard.html";
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
                btn.disabled = false;
            }
        };

        loadProfile();
    </script>
</body>
</html>
