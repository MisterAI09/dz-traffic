// إعدادات الربط
const SUPABASE_URL = "https://nbioqaxgjzpyrbcwdkds.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaW9xYXhnanpweXJiY3dkZHMuY28iLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczMjgxODk0NSwiZXhwIjoyMDQ4Mzk0OTQ1fQ.6L-9K_8XvX5H_x_x_x_x_x_x"; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function loadUserData() {
    const { data: { user } } = await _supabase.auth.getUser();
    if (user) {
        const { data: profile } = await _supabase.from('profiles').select('points').eq('id', user.id).single();
        document.getElementById('userPoints').innerText = profile?.points || 0;
    }
}

async function loadAds() {
    const { data: ads } = await _supabase.from('ads').select('*');
    const container = document.getElementById('adsContainer');
    container.innerHTML = ''; // تنظيف الحاوية

    ads.forEach(ad => {
        container.innerHTML += `
            <div class="bg-white p-4 rounded-lg shadow border-r-4 border-blue-500 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg">${ad.title}</h3>
                    <p class="text-sm text-gray-500">شاهد لمدة ${ad.required_time} ثانية</p>
                </div>
                <button id="btn-${ad.id}" onclick="startTask('${ad.url}', ${ad.reward_points}, ${ad.required_time}, ${ad.id})" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                    كسب ${ad.reward_points} نقطة
                </button>
            </div>`;
    });
}

function startTask(url, points, seconds, adId) {
    const btn = document.getElementById(`btn-${adId}`);
    btn.disabled = true;
    btn.innerText = `انتظر ${seconds}ث...`;

    // فتح الإعلان في نافذة جديدة
    window.open(url, '_blank');

    // بدء العداد التنازلي
    let timeLeft = seconds;
    const timer = setInterval(async () => {
        timeLeft--;
        btn.innerText = `انتظر ${timeLeft}ث...`;

        if (timeLeft <= 0) {
            clearInterval(timer);
            btn.innerText = "جاري إضافة النقاط...";
            await addPointsToUser(points);
            btn.innerText = "تمت المهمة ✅";
            btn.classList.replace('bg-green-500', 'bg-gray-400');
        }
    }, 1000);
}

async function addPointsToUser(pointsToAdd) {
    const { data: { user } } = await _supabase.auth.getUser();
    if (user) {
        // جلب النقاط الحالية أولاً
        const { data: profile } = await _supabase.from('profiles').select('points').eq('id', user.id).single();
        const newPoints = (profile?.points || 0) + pointsToAdd;

        // تحديث النقاط في قاعدة البيانات
        const { error } = await _supabase.from('profiles').update({ points: newPoints }).eq('id', user.id);

        if (!error) {
            document.getElementById('userPoints').innerText = newPoints;
            alert(`مبروك! ربحت ${pointsToAdd} نقطة.`);
        }
    }
}

loadUserData();
loadAds();
